<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/styles.css">
  <link rel="stylesheet" href="./css/querys.css">
  <script src="./js/reviewsbackend.js"></script>
  <link rel="stylesheet" href="./css/backend.css">
  <script src="./js/vuelve.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- <script src="./js/script.js"></script> -->
  <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.freepik.com/512/2983/2983665.png">
  <title>API Cementerio</title>
</head>

<body id="back">
  <header>
    <h2 class="logo"></h2>
    <nav class="navigation">
      <a href="./index.html">Home<span></span></a>
      <a href="./index.html#about">About<span></span></a>
      <a href="./index.html#service">Service<span></span></a>
      <a href="./index.html#prod">Productos<span></span></a>
      <span id="login-status"></span>
      <button id="logout-button" style="display: none;"><i class="fa-solid fa-right-from-bracket"></i></button>
    </nav>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const loginStatus = document.getElementById('login-status');
        const logoutButton = document.getElementById('logout-button');

        // Verificar si hay un nombre de usuario almacenado en localStorage
        const username = localStorage.getItem('username');
        if (username) {
          loginStatus.textContent = ` ${username}`; // Mostrar el nombre de usuario en el nav
          logoutButton.style.display = 'inline'; // botón de cerrar sesión
        } else {
          loginStatus.innerHTML = '<a href="./login.html">Login<span></span></a>'; 
          // Si no hay usuario logeado, mostrar el enlace pal login
        }

        logoutButton.addEventListener('click', () => {
          // Eliminar los datos del usuario del localStorage al hacer clic en cerrar sesion
          localStorage.removeItem('username');
          localStorage.removeItem('token');
          // Redirigir al usuario a la página del login despue de cerrar sesión
          window.location.href = './login.html';
        });
      });
    </script>

    <nav role="navigation">
      <div id="menuToggle">
        <input type="checkbox" />
        <span></span>
        <span></span>
        <span></span>
        <ul id="menu">
          <a href="./index.html#">
            <li>Home</li>
          </a>
          <a href="./index.html#service">
            <li>Service</li>
          </a>
          <a href="./index.html#about">
            <li>About</li>
          </a>
          <a href="./index.html#prod">
            <li>Productos</li>
          </a>
        </ul>
      </div>
    </nav>
  </header>
  <section>


    <form id="formulario-ataud">
    <label for="buscador">Buscar:</label>
    <input type="text" id="buscador" name="buscador">
      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" name="nombre" required><br>

      <label for="categoria">Categoría:</label>
      <select id="categoria" name="categoria" required>
        <option value="Haymaker">Haymaker</option>
        <option value="Beco">Beco</option>
        <option value="Brown smallest">Brown Smallest</option>
      </select><br>
      

      <label for="precio">Precio:</label>
      <input type="number" id="precio" name="precio" required><br>

      <label for="material">Material:</label>
      <input type="text" id="material" name="material" required><br>

      <label for="imagen">Imagen:</label>
      <input type="text" id="imagen" name="imagen" required><br>
      <button type="submit" class="insert-button">+</button>
    </form>

    <div class="tbl-header">
      <table cellpadding="0" cellspacing="0" border="0">
        <thead>
          <tr>
            <th>ID</th>
            <th>NOMBRE</th>
            <th>CATEGORIA</th>
            <th>PRECIO</th>
            <th>MATERIAL</th>
            <th>IMAGEN</th>
            <th>Actions</th> 
          </tr>
        </thead>
      </table>
    </div>
    <div class="tbl-content">
      <table cellpadding="0" cellspacing="0" border="0">
        <tbody>
          <!-- Los datos del js se veran aqui -->
        </tbody>
      </table>
    </div>
    <div class="row2s">
      <div id="col"></div>
  </div>
  </section>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem('token');
      if (!token) {
        // Si no hay un token de sesión en el localStorage, redirigir al usuario al login
        window.location.href = 'login.html';
      } else {
        const loginStatus = document.getElementById('login-status');
        const logoutButton = document.getElementById('logout-button');
        const username = localStorage.getItem('username');
        if (username) {
          loginStatus.textContent = ` ${username}`; // Mostrar el nombre de usuario en el nav
          logoutButton.style.display = 'inline'; // botón de cerrar sesión
        } else {
          loginStatus.innerHTML = '<a href="./login.html">Login<span></span></a>'; 
          // Si no hay usuario logeado, mostrar el enlace pal login
        }

        logoutButton.addEventListener('click', () => {
          // Eliminar los datos del usuario del localStorage al hacer clic en cerrar sesion
          localStorage.removeItem('username');
          localStorage.removeItem('token');

          // Redirigir al usuario a la página del login despue de cerrar sesión
          window.location.href = './login.html';
        });
      }
      //  funcion para poner los puntos a los numeros
      function formatNumberWithPoints(number) {
          return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }
  
      // Quitar las tildes para que el buscador funke bien
      function removeAccents(text) {
          return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }
      const inputBuscador = document.getElementById('buscador');
      inputBuscador.addEventListener('input', () => {
          const textoBusqueda = removeAccents(inputBuscador.value.toLowerCase().trim());
          const filas = document.querySelectorAll('.tbl-content tbody tr');
  
          filas.forEach(fila => {
              const textoFila = removeAccents(fila.textContent.toLowerCase());
              if (textoFila.includes(textoBusqueda)) {
                  fila.style.display = '';
              } else {
                  fila.style.display = 'none';
              }
          });
      });
  
      // listener para el botón de logout
      const logoutButton = document.getElementById('logout-button');
      logoutButton.addEventListener('click', () => {
          localStorage.removeItem('username');
          localStorage.removeItem('token');
          window.location.href = './login.html';
      });
  
      // Obtener datos de atadues
      fetch('http://localhost:3001/ataudes')
          .then(response => response.json())
          .then(data => {
              const tableBody = document.querySelector('.tbl-content tbody');
  
              data.forEach(item => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                      <td>${formatNumberWithPoints(item.id)}</td>
                      <td>${item.nombre}</td>
                      <td>${item.categoria}</td>
                      <td>${formatNumberWithPoints(item.precio)}€</td> 
                      <td>${item.material}</td>
                      <td><img src="${item.imagen}" alt="${item.nombre}" width="100"></td>
                      <td><button class="delete-button" data-id="${item.id}"><i class="fa-solid fa-trash"></i></button></td>
                  `;
                  tableBody.appendChild(row);
              });
  
              // listener para los botones de borrar
              document.querySelectorAll('.delete-button').forEach(button => {
                  button.addEventListener('click', () => {
                      const id = button.getAttribute('data-id');
                      const confirmDelete = confirm("¿Estás seguro de que deseas eliminar este ataúd?");
                      if (confirmDelete) {
                          fetch(`http://localhost:3001/ataudes/${id}`, {
                              method: 'DELETE'
                          })
                              .then(() => {
                                  // Eliminar la fila de la tabla una vez que se ha eliminado el ataúd
                                  button.closest('tr').remove();
                              })
                              .catch(error => {
                                  console.error('Error al eliminar el ataúd:', error);
                              });
                      }
                  });
              });
          })
          .catch(error => {
              console.error('Error al cargar los datos:', error);
          });
  });
  
  </script>
</body>

</html>